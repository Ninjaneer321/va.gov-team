# .github/workflows/diversity-data-extraction.yml
#
# Purpose: Extract participant demographic data from research findings reports
# and aggregate for quarterly diversity reporting. Runs at the end of each quarter
# and tracks processed files to avoid duplication.
#
# Repository: va.gov-team (with sparse checkout)
# Reports pushed to: va.gov-research-repository/reports/quarterly-reports/diversity-reports/

name: Diversity Data Extraction

on: 
  schedule:
    # Run on first day after each quarter ends at 8:00 AM ET (13:00 UTC)
    # Q1 (Jan-Mar) report runs April 1
    # Q2 (Apr-Jun) report runs July 1
    # Q3 (Jul-Sep) report runs October 1
    # Q4 (Oct-Dec) report runs January 1
    - cron: '0 13 1 1,4,7,10 *'
  workflow_dispatch: 
    inputs:
      full_scan:
        description: 'Force reprocessing of all files (ignores processed manifest)'
        required: false
        default: 'false'
        type: boolean
      quarter:
        description: 'Specific quarter to process (e.g., 2026-Q1). Leave empty for auto-detect.'
        required: false
        default: ''
        type: string
      dry_run:
        description: 'Test run - do not push to research repository'
        required: false
        default: 'false'
        type: boolean

jobs:
  extract-diversity-data: 
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps: 
      - name: Sparse Checkout - Research Findings Only
        if: ${{ github.event.inputs.full_scan != 'true' }}
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            products/**/research
            teams/**/research
            .github/scripts
          sparse-checkout-cone-mode: false
          fetch-depth: 0

      - name: Full Checkout
        if: ${{ github.event.inputs.full_scan == 'true' }}
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with: 
          node-version: '20'

      - name: Install dependencies
        run: |
          npm install js-yaml glob

      - name: Clone research repository for manifest
        id: clone-repo
        env:
          GH_TOKEN: ${{ secrets.WORKFLOWS_PERMISSIONS }}
        run: |
          mkdir -p research-repo/reports/quarterly-reports/diversity-reports

          echo "Cloning research repository..."
          if git clone https://x-access-token:${GH_TOKEN}@github.com/department-of-veterans-affairs/va.gov-research-repository.git research-repo-temp; then
            echo "Successfully cloned research repository"
            rm -rf research-repo
            mv research-repo-temp research-repo
            echo "repo_cloned=true" >> $GITHUB_OUTPUT
            mkdir -p research-repo/reports/quarterly-reports/diversity-reports
          else
            echo "::error::Failed to clone research repository. Check that WORKFLOWS_PERMISSIONS token is valid."
            exit 1
          fi

          if [ ! -f "research-repo/reports/quarterly-reports/diversity-reports/processed-files.json" ]; then
            echo '{"processed_files": [], "last_updated": null, "quarters_processed": []}' > research-repo/reports/quarterly-reports/diversity-reports/processed-files.json
            echo "Created new empty manifest"
          fi

      - name: Extract demographic data from findings
        id: extract
        uses: actions/github-script@v7
        with:
          script: |
            const { run } = require('./.github/scripts/diversity-data-extraction.js');
            const globModule = require('glob');
            
            const fullScan = '${{ github.event.inputs.full_scan }}' === 'true';
            const inputQuarter = '${{ github.event.inputs.quarter }}' || '';
            
            await run({
              globModule,
              core,
              fullScan,
              inputQuarter
            });

      - name: Upload diversity data artifact
        uses: actions/upload-artifact@v4
        with: 
          name: diversity-data-${{ steps.extract.outputs.quarter_label }}
          path: |
            diversity-summary.md
            diversity-data.json
          retention-days: 90

      - name: Push reports to va.gov-research-repository
        if: ${{ github.event.inputs.dry_run != 'true' }}
        env:
          GH_TOKEN: ${{ secrets.WORKFLOWS_PERMISSIONS }}
        run: |
          cd research-repo

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          QUARTER_LABEL="${{ steps.extract.outputs.quarter_label }}"

          mkdir -p reports/quarterly-reports/diversity-reports

          cp "../diversity-summary-${QUARTER_LABEL}.md" "reports/quarterly-reports/diversity-reports/diversity-summary-${QUARTER_LABEL}.md"
          cp "../diversity-data-${QUARTER_LABEL}.json" "reports/quarterly-reports/diversity-reports/diversity-data-${QUARTER_LABEL}.json"

          cp "../diversity-summary-${QUARTER_LABEL}.md" "reports/quarterly-reports/diversity-reports/diversity-summary-latest.md"
          cp "../diversity-data-${QUARTER_LABEL}.json" "reports/quarterly-reports/diversity-reports/diversity-data-latest.json"

          if [ ! -f "reports/quarterly-reports/diversity-reports/README.md" ]; then
            cat > reports/quarterly-reports/diversity-reports/README.md << 'EOF'
          # Diversity Reports

          This folder contains automatically generated quarterly diversity data reports from research findings.

          ## Report Files

          - `diversity-summary-latest.md` - Most recent quarterly summary report
          - `diversity-data-latest.json` - Most recent data in JSON format
          - `processed-files.json` - Manifest tracking all processed research files
          - Quarter-specific reports (e.g., `diversity-summary-2026-Q1.md`) are retained for historical tracking

          ## Data Source

          These reports are automatically generated from research findings in the va.gov-team repository.
          They aggregate participant demographic data for quarterly diversity reporting.

          ## Update Schedule

          Reports are generated quarterly:
          - Q1 (Jan-Mar) report runs on April 1
          - Q2 (Apr-Jun) report runs on July 1
          - Q3 (Jul-Sep) report runs on October 1
          - Q4 (Oct-Dec) report runs on January 1

          ## File Tracking

          The workflow maintains a manifest (`processed-files.json`) to track which research files have been
          processed. This ensures each study is only counted once and prevents duplication across quarters.
          EOF
          fi

          if git diff --quiet && git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git add reports/
            git commit -m "Update diversity data reports - ${QUARTER_LABEL}

          Quarterly diversity data extraction from va.gov-team research findings.

          Quarter: ${QUARTER_LABEL}
          Studies analyzed: ${{ steps.extract.outputs.study_count }}
          Total participants: ${{ steps.extract.outputs.participant_count }}
          Files skipped: ${{ steps.extract.outputs.skipped_count }}

          Generated by: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

            git push
            echo "Reports pushed successfully to va.gov-research-repository"
          fi

      - name: Dry run notice
        if: ${{ github.event.inputs.dry_run == 'true' }}
        run: |
          echo "::notice::DRY RUN - Reports were generated but NOT pushed to va.gov-research-repository"
          echo "## ðŸ§ª Dry Run Mode" >> $GITHUB_STEP_SUMMARY
          echo "Reports were generated and uploaded as artifacts but **not pushed** to va.gov-research-repository." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Quarter:** ${{ steps.extract.outputs.quarter_label }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Post summary
        run: |
          cat diversity-summary.md >> $GITHUB_STEP_SUMMARY
